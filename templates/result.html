{% extends "base.html" %}

{% block title %}분석 결과 - SKINMATE{% endblock %}

{% block head %}
<style>
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .chart-item {
        flex: 1;
        padding: 10px;
    }
    .flex-spacer {
        flex: 0.5; /* Adjust this to control the shift */
    }
    #segmented-bars-container {
        display: flex;
        flex-direction: column;
    }
    .bar-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        width: 100%;
    }
    .bar-label {
        width: 50px;
        font-weight: bold;
        font-size: 16px;
        word-break: keep-all;
        white-space: nowrap;
    }
    .segmented-bar {
        display: flex;
        width: 100%;
        flex-grow: 1;
        height: 25px;
        border-radius: 5px;
        overflow: hidden;
        border: 1px solid #e0e0e0;
    }
    .segment {
        flex: 1;
        background-color: #f0f0f0;
        border-left: 1px solid #fff;
    }
    .segment:first-child {
        border-left: none;
    }
    .segment.filled {
        background-color: #D8AAAA;
    }
</style>
{% endblock %}

{% block content %}
<div class="all-result-container">
    <h2>AI 피부 분석 결과</h2>

    <div class="chart-container">
        <div id="gauge-chart" class="chart-item"></div>
        <div id="segmented-bars-container" class="chart-item">
            <div class="bar-container">
                <span class="bar-label">수분</span>
                <div class="segmented-bar" data-score="{{ scores.moisture | default(0, true) }}">
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                </div>
            </div>
            <div class="bar-container">
                <span class="bar-label">탄력</span>
                <div class="segmented-bar" data-score="{{ scores.elasticity | default(0, true) }}">
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                </div>
            </div>
            <div class="bar-container">
                <span class="bar-label">주름</span>
                <div class="segmented-bar" data-score="{{ scores.wrinkle | default(0, true) }}">
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                    <div class="segment"></div>
                </div>
            </div>
        </div>
        <div class="flex-spacer"></div>
    </div>

    <div class="result-details-box">
        <div class="result-description">
             <p>{{ result_summary | safe }}</p>
        </div>
        <div class="button-group">
            <a href="{{ url_for('analysis') }}" class="result-button-retry">다시 테스트하기</a>
            <a href="{{ url_for('recommendations') }}" class="result-button-recommend">추천 상품 보러가기</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    // Data from Flask
    var mainScore = {{ main_score | round }};

    // Gauge Chart
    var gaugeOptions = {
        series: [mainScore],
        chart: {
            height: 350,
            type: 'radialBar',
        },
        plotOptions: {
            radialBar: {
                startAngle: -135,
                endAngle: 135,
                hollow: {
                    margin: 0,
                    size: '70%',
                    background: '#fff',
                },
                track: {
                    background: '#f2f2f2',
                    strokeWidth: '67%',
                },
                dataLabels: {
                    name: {
                        show: true,
                        offsetY: -25,
                        fontSize: '16px',
                        color: '#888',
                        formatter: function(val) { return "Total Score" }
                    },
                    value: {
                        offsetY: 30,
                        fontSize: '4.2rem',
                        color: '#1f1f1fff',
                        formatter: function (val) {
                            return val.toFixed(0);
                        }
                    }
                }
            }
        },
        labels: ['종합 점수'],
        colors: ['#D8AAAA'],
        fill: {
            type: 'gradient',
            gradient: {
                shade: 'dark',
                type: 'horizontal',
                shadeIntensity: 0.5,
                gradientToColors: ['#C79999'],
                inverseColors: true,
                opacityFrom: 1,
                opacityTo: 1,
                stops: [0, 100]
            }
        },
        stroke: {
            lineCap: 'round'
        },
    };

    var gaugeChart = new ApexCharts(document.querySelector("#gauge-chart"), gaugeOptions);
    gaugeChart.render();

    // Segmented Bars
    document.querySelectorAll('.segmented-bar').forEach(bar => {
        const score = parseFloat(bar.dataset.score);
        let level = 0;
        if (score < 20) level = 1;
        else if (score < 40) level = 2;
        else if (score < 60) level = 3;
        else if (score < 80) level = 4;
        else level = 5;

        const segments = bar.querySelectorAll('.segment');
        for (let i = 0; i < level; i++) {
            if(segments[i]) {
                segments[i].classList.add('filled');
            }
        }
    });
</script>
{% endblock %}